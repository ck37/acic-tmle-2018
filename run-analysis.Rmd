---
title: "Run analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("R/function_library.R")
# Load/install necessary packages.
startup(auto_install = FALSE, verbose = TRUE)
# Load all .R files in R/
ck37r::load_all_code("R")
```

## Configure analysis

```{r config}
(conf = list(
  input_dir_counterfactuals = "data-raw/practice-censoring",
  input_file_covariates = "data-raw/x.csv",
  output_file_ate = "exports/ate-test.csv",
  # IPO = Individual potential outcomes
  output_dir_ipo = "exports/ipo-test"
))

results = list()
```

## Analysis: revere

```{r analysis_revere}

# Generate analyses
results$revere =
  run_analysis(
    input_dir_counterfactuals = conf$input_dir_counterfactuals,
    input_file_covariates = conf$input_file_covariates,
    tmle_wrapper = wrapper_revere_basic,
    # specific_files = c("d1546da12d8e4daf8fe6771e2187954d"),
    verbose = TRUE)
# Now we have:
# $ate - dataframe of ate estimates
# $ipos - list with individual potential outcome estimates for each file.
# $cf_files - vector of files to use for evaluating our estimates. 
names(results$revere)
```

## Evaluate: revere

Evaluate our estimates if we have counterfactual files.

```{r eval_estimates}
if (exists("results") && "revere" %in% names(results) &&
    "cf_files" %in% names(results$revere) && length(results$revere$cf_files) > 0L) {
  stats = evaluate_estimates(results$revere, verbose = TRUE)
  print(stats)
  save(results, stats,
       file = "data/revere-results-stats.RData")
}
```

## Analysis: tmle

```{r analysis_tmle}

# Generate analyses
results_tmle =
  run_analysis(
    input_dir_counterfactuals = conf$input_dir_counterfactuals,
    input_file_covariates = conf$input_file_covariates,
    #tmle_wrapper = wrapper_tmle,
    tmle_wrapper = wrapper_tmle_better,
    verbose = TRUE)
# Now we have:
# $ate - dataframe of ate estimates
# $ipos - list with individual potential outcome estimates for each file.
# $cf_files - vector of files to use for evaluating our estimates. 
names(results_tmle)
```

## Evaluate: tmle

Evaluate our estimates if we have counterfactual files.

```{r eval_estimates}
if (exists("results_tmle") && "cf_files" %in% names(results_tmle) && length(results_tmle$cf_files) > 0L) {
  stats = evaluate_estimates(results_tmle, verbose = TRUE)
  print(stats)
}
```

## Create output files

```{r create_output}
output_files =
  create_output_files(
    results,
    output_file_ate = conf$output_file_ate,
    output_dir_ipo = conf$output_dir_ipo,
    verbose = TRUE)
```

## Submit entry

```{r submit_entry}
# Submit entry programmatically using R.
```